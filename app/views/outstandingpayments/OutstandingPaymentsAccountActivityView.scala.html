@*
 * Copyright 2024 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import _root_.utils.DateTimeUtils._
@import config.FrontendAppConfig
@import models.OutstandingPaymentSummary
@import views.ViewUtils._
@import views.html.components.gds._
@import views.html.templates.Layout

@this(
        layout: Layout,
        govukBackLink: GovukBackLink,
        govukTable: GovukTable,
        govukButton: GovukButton,
        govukInsetText: GovukInsetText,
        h1: heading,
        h2: HeadingH2,
        paragraphBody: paragraphBody,
        paragraphMessageWithLink: ParagraphMessageWithLink
)
@(data: Seq[OutstandingPaymentSummary], plrReference: String, amountDue: BigDecimal, hasOverdueReturnPayment: Boolean)(implicit request: Request[_], appConfig: FrontendAppConfig, messages: Messages, isAgent: Boolean)

@layout(pageTitle = titleNoForm(messages("payments.outstanding.title")), twoThirdsPagelayout = false, bannerUrl = Some(routes.HomepageController.onPageLoad().url)) {

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            @h1(messages("payments.outstanding.title"))
            @h2(messages("payments.outstanding.amountDue", formatAmount(amountDue)), size = "m")
            @paragraphBody(messages("payments.outstanding.p1"))
            @paragraphBody(userTypeDependentText(
                messages("payments.outstanding.p2"),
                messages("payments.outstanding.agent.p2")
                )
            )
            @if(hasOverdueReturnPayment) {
                @govukInsetText(InsetText(content= Text(userTypeDependentText(
                        messages("payments.outstanding.insetText"),
                        messages("payments.outstanding.agent.insetText")
                ))))
            }
            @govukButton(
                ButtonViewModel(
                    messages("payments.outstanding.pay.buttonText")
                ).asLink(controllers.payments.routes.MakeAPaymentDashboardController.onRedirect().url))

            @h2(messages("payments.outstanding.otherWaysToPay.heading"), size = "m")
            @paragraphBody(
                userTypeDependentText(
                    messages("payments.outstanding.otherWaysToPay.p1", plrReference),
                    messages("payments.outstanding.otherWaysToPay.agent.p1", plrReference)
                )
            )
            @paragraphBody(
                userTypeDependentText(
                    messages("payments.outstanding.otherWaysToPay.p2"),
                    messages("payments.outstanding.otherWaysToPay.agent.p2")
                )
            )
            @paragraphMessageWithLink(
                linkMessage = messages("payments.outstanding.otherWaysToPay.linkText"),
                linkUrl = appConfig.howToPayPillar2TaxesUrl,
                target = "_blank"
            )
        </div>
    </div>

    @h2(messages("payments.outstanding.details.heading"), size = "m")
    @paragraphBody(messages("payments.outstanding.details.p1"))

    @{
        if(amountDue <= 0) {
            paragraphBody(messages("payments.outstanding.details.nothingDue"), classes = "govuk-body govuk-!-margin-bottom-8 govuk-!-margin-top-7")
        } else {
            data.map { summary =>
                govukTable(Table(
                    head = Some(
                        Seq(
                            HeadCell(Text("Description"), classes = "govuk-!-width-one-half"),
                            HeadCell(Text("Amount"), format = Some("numeric"), classes = "govuk-!-width-one-quarter"),
                            HeadCell(Text("Due date"), classes = "govuk-!-width-one-quarter"),
                        )
                    ),
                    rows =  summary.items.map { item =>
                        Seq(
                            TableRow(content = Text(item.description)),
                            TableRow(content = Text(formatCurrencyAmount(item.outstandingAmount)), format = Some("numeric")),
                            TableRow(content = Text(item.dueDate.toDateFormat))
                        )
                    },
                    caption = Some(s"Accounting period: ${summary.accountingPeriod.startDate.toDateFormat} to ${summary.accountingPeriod.endDate.toDateFormat}"),
                    captionClasses = "govuk-table__caption--s",
                ))
            }
        }
    }

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            @h2(messages("transactionHistory.title"), size = "m")
            @paragraphBody(messages("payments.outstanding.transactionHistory.p1"))
            @paragraphBody(messages("payments.outstanding.transactionHistory.p2"))
            @paragraphMessageWithLink(
                linkMessage = messages("homepage.payments.transactionHistory.linkText"),
                linkUrl = routes.TransactionHistoryController.onPageLoadTransactionHistory(None).url
            )

            @h2(messages("payments.outstanding.penaltiesAndCharges.heading"), size = "m")
            @paragraphBody(
                userTypeDependentText(
                    messages("payments.outstanding.penaltiesAndCharges.p1"),
                    messages("payments.outstanding.penaltiesAndCharges.agent.p1")
                )
            )
            @paragraphMessageWithLink(
                linkMessage = messages("payments.outstanding.penaltiesAndCharges.linkText"),
                linkUrl = appConfig.penaltiesInformationUrl,
                target = "_blank"
            )
        </div>
    </div>
}
