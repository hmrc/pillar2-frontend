@*
 * Copyright 2024 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.FrontendAppConfig
@import uk.gov.hmrc.govukfrontend.views.html.components._
@import views.html.components.gds._
@import views.html.templates.Layout

@import java.time.LocalDate
@import java.time.format.DateTimeFormatter


@this(layout: Layout, heading: heading, paragraphBody: paragraphBody, link: link, card: HomepageCard, govukNotificationBanner : GovukNotificationBanner)

@(organisationName: String, registrationDate: String, maybeBTNBannerDate: Option[LocalDate], maybeUktrBannerScenario: Option[String], plrReference: String, isAgent: Boolean, agentHasClientSetup: Boolean)(implicit request: Request[_], appConfig: FrontendAppConfig, messages: Messages)

@submissionFrontendPath = @{s"${appConfig.submissionFrontendHost}/report-pillar2-submission-top-up-taxes"}
@maybeAgentKey = @{if(isAgent) ".agent" else ""}

@* Agent routing logic: If agent hasn't completed client setup, send to ASA first *@
@dueAndOverdueReturnsUrl = @{
  if (isAgent && !agentHasClientSetup) {
    s"$submissionFrontendPath/asa/input-pillar-2-id"
  } else {
    s"$submissionFrontendPath/due-and-overdue-returns"
  }
}

@submissionHistoryUrl = @{
  if (isAgent && !agentHasClientSetup) {
    s"$submissionFrontendPath/asa/input-pillar-2-id"  
  } else {
    s"$submissionFrontendPath/submission-history"
  }
}

@btnUrl = @{
  if (isAgent && !agentHasClientSetup) {
    s"$submissionFrontendPath/asa/input-pillar-2-id"
  } else {
    s"$submissionFrontendPath/below-threshold-notification/start"
  }
}

@bannerHtml = {
 <div style="max-width: fit-content">
  @paragraphBody(messages("homepage.btnActiveBanner.title", if(isAgent) organisationName else "Your account"), "govuk-notification-banner__heading")
  @paragraphBody(messages(s"homepage.btnActiveBanner$maybeAgentKey.body", maybeBTNBannerDate.get.format(DateTimeFormatter.ofPattern("d MMMM yyyy"))))
  @link(
   text = messages("homepage.btnActiveBanner.linkText"),
   call = Call("GET", btnUrl),
   classes = Some("govuk-notification-banner__link")
  )
 </div>
}



@layout(pageTitle = noTitle, showBackLink = false, twoThirdsPagelayout = false) {

  @if(maybeBTNBannerDate.isDefined) {
    @govukNotificationBanner(NotificationBanner(content = HtmlContent(bannerHtml), classes = "govuk-!-margin-bottom-0"))
  }

  <h1 class="govuk-heading-l" style="margin-top: -8px;">@messages("homepage.title")</h1>

  <p class="govuk-body" style="margin-bottom: 2.5em; display: flex; flex-wrap: wrap; gap: 0.5em;">
   <span><b>@{messages("homepage.group")}:</b> @organisationName</span>
   <span><b>@{messages("homepage.id")}:</b> @plrReference</span>
  </p>
  <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">


 @maybeUktrBannerScenario.map { scenario =>
  <h2 class="govuk-heading-m">@messages(s"homepage.uktrBanner$maybeAgentKey.$scenario.title")</h2>
  <p class="govuk-body">@messages(s"homepage.uktrBanner$maybeAgentKey.$scenario.body")</p>
  <p class="govuk-body" style="margin-bottom: 2.6em;">
    @link(
      text = messages("homepage.uktrBanner.linkText"),
      call = Call("GET", dueAndOverdueReturnsUrl),
      id = Some("submission-link")
    )
  </p>
  <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">
 }

 <div style="display: flex; flex-wrap: wrap; margin-top: 2em;">
      @if(maybeUktrBannerScenario.isDefined) {
    <div class="govuk-!-margin-right-5 govuk-!-margin-bottom-4 card-main">
      <div class="card-label">
        <h2 class="govuk-heading-m">
          @messages("homepage.returns.title")
          @maybeUktrBannerScenario.map { scenario =>
            @if(scenario == "Overdue" || scenario == "Incomplete") {
              <span class="govuk-tag @{
                scenario match {
                  case "Overdue" => "govuk-tag--red"
                  case "Incomplete" => "govuk-tag--purple"
                }
              } govuk-!-margin-right-5" aria-label="@{scenario} returns" title="@{scenario} returns" style="float: right;">@scenario</span>
            }
          }
        </h2>
      </div>
      <div class="card-content">
       <ul class="govuk-list">
        <li class="card-links">
         <a href="@dueAndOverdueReturnsUrl" class="govuk-link">@messages("homepage.returns.dueOverdueReturns.linkText")</a>
        </li>
        <li class="card-links">
         <a href="@submissionHistoryUrl" class="govuk-link">@messages("homepage.returns.submissionHistory.linkText")</a>
        </li>
       </ul>
      </div>
    </div>
   } else {
    @card(
     title = messages("homepage.returns.title"),
     links = Seq(
      (messages("homepage.returns.dueOverdueReturns.linkText"), dueAndOverdueReturnsUrl, None),
      (messages("homepage.returns.submissionHistory.linkText"), submissionHistoryUrl, None),
     ),
     cardClass = "card-main"
    )
   }

   @card(
    title = messages("homepage.payments.title"),
    links = Seq(
     (messages("homepage.payments.transactionHistory.linkText"), controllers.routes.TransactionHistoryController.onPageLoadTransactionHistory(None).url, None),
     (messages("homepage.payments.outstandingPayments.linkText"), controllers.routes.UnderConstructionController.onPageLoad.url, None),
     (messages("homepage.payments.repayments.linkText"), controllers.repayments.routes.RequestRefundBeforeStartController.onPageLoad.url, None),
    ),
    cardClass = "card-main"
   )

   @{
    val registrationContent = Html(
     s"""
       <p class="govuk-body">
           <b>${messages("homepage.manageAccount.registrationDate")}:</b> $registrationDate
       </p>
     """
    )

    card(
     title = messages("homepage.manageAccount.title"),
     links = manageAccountLinks(isAgent),
     extraContent = Some(registrationContent),
     cardClass = "card-full-width"
    )
   }
   <style>
     .card-main {
       height: auto; 
       width: 450px;
       border: solid #b1b4b6 1px;
     }

     div[class*="card-full-width"] { 
       margin-top: -0.3rem !important; 
       margin-bottom: 0 !important;
     }
   </style>
 </div>
}

@manageAccountLinks(isAgent: Boolean) = @{
 Seq(
  (
          messages("homepage.manageAccount.manageContactDetails.linkText"),
          controllers.subscription.manageAccount.routes.ManageContactCheckYourAnswersController.onPageLoad.url,
          Some(messages(s"homepage.manageAccount$maybeAgentKey.manageContactDetails.body"))
  ),
  (
          messages("homepage.manageAccount.manageGroupDetails.linkText"),
          controllers.subscription.manageAccount.routes.ManageGroupDetailsCheckYourAnswersController.onPageLoad.url,
          Some(messages(s"homepage.manageAccount$maybeAgentKey.manageGroupDetails.body"))
  ),
  (
          messages("homepage.manageAccount.rfm.linkText"),
          if(isAgent) "" else controllers.rfm.routes.StartPageController.onPageLoad.url,
          Some(messages(s"homepage.manageAccount$maybeAgentKey.rfm.body"))
  ),
  (
          messages("homepage.manageAccount.btn.linkText"),
          btnUrl,
          Some(messages(s"homepage.manageAccount$maybeAgentKey.btn.body"))
  )
 )
}