@*
 * Copyright 2024 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.FrontendAppConfig
@import models.DueAndOverdueReturnBannerScenario._
@import models.OutstandingPaymentBannerScenario._
@import models.subscription.AccountStatus
@import uk.gov.hmrc.govukfrontend.views.html.components._

@import views.html.components.gds._
@import views.html.DynamicNotificationAreaView
@import views.html.templates.Layout

@this(
    layout: Layout,
    heading: heading,
    paragraphBody: paragraphBody,
    link: link,
    card: HomepageCard,
    govukNotificationBanner: GovukNotificationBanner,
    dynamicNotificationArea: DynamicNotificationAreaView,
    paragraphMessageWithLink: ParagraphMessageWithLink,
)

@(
    organisationName: String,
    registrationDate: String,
    btnBanner: BtnBanner,
    maybeUktrBannerScenario: Option[DueAndOverdueReturnBannerScenario],
    maybePaymentBannerScenario: Option[OutstandingPaymentBannerScenario],
    dynamicNotificationAreaState: DynamicNotificationAreaState,
    plrReference: String,
    isAgent: Boolean,
    hasReturnsUnderEnquiry: Boolean
)(implicit request: Request[_], appConfig: FrontendAppConfig, messages: Messages)

@maybeAgentKey = @{if(isAgent) ".agent" else ""}

@dueAndOverdueReturnsUrl = @{
  controllers.dueandoverduereturns.routes.DueAndOverdueReturnsController.onPageLoad.url
}

@submissionHistoryUrl = @{
  controllers.submissionhistory.routes.SubmissionHistoryController.onPageLoad.url
}

@btnUrl = @{
  controllers.btn.routes.BTNBeforeStartController.onPageLoad.url
}

@bannerHtml = {
 <div class="btn-banner">
  @paragraphBody(messages("homepage.btnActiveBanner.title", if(isAgent) organisationName else "Your account"), "govuk-notification-banner__heading")
  @paragraphBody(messages(s"homepage.btnActiveBanner$maybeAgentKey.body"))
  @link(
   text = messages("homepage.btnActiveBanner.linkText"),
   call = Call("GET", btnUrl),
   classes = Some("govuk-notification-banner__link")
  )
 </div>
}

@layout(pageTitle = noTitle, showBackLink = false, twoThirdsPagelayout = false, bannerUrl = Some(routes.DashboardController.onPageLoad.url)) {

  @btnBanner match {
    case BtnBanner.Show => {@govukNotificationBanner(NotificationBanner(content = HtmlContent(bannerHtml)))}
    case BtnBanner.Hide => {}
  }

  <h1 class="govuk-heading-l">@messages("homepage.title")</h1>

  <p class="govuk-body homepage-title">
   <span><strong>@{messages("homepage.group")}:</strong> @organisationName</span>
   <span><strong>@{messages("homepage.id")}:</strong> @plrReference</span>
  </p>

  @if(isAgent) {
    @paragraphMessageWithLink(linkMessage = messages("dashboard.agent.changeClientLink"),
        linkUrl = routes.AgentController.onPageLoadClientPillarId.url)
  }

@dynamicNotificationArea(dynamicNotificationAreaState, isAgent)

 <div class="card-group">
    @maybeUktrBannerScenario match {
        case Some(returnScenario) => {
            <div class="card-half-width">
                <div class="govuk-summary-card__title-wrapper card-with-tag">
                    <h2 class="govuk-heading-m govuk-!-margin-0">@messages("homepage.returns.title")</h2>
                    @returnScenario match {
                        case scenario @ (Overdue | Incomplete | Received) => {@defining(scenario.toString) { scenarioString =>
                            <span class="govuk-tag @{
                                scenario match {
                                    case Overdue => "govuk-tag--red"
                                    case Incomplete => "govuk-tag--purple"
                                    case Received => "govuk-tag--green"
                                }
                            }" aria-label="@{scenarioString} returns" title="@{scenarioString} returns">@scenarioString</span>
                        }}
                        case Due => {}
                    }
                </div>
                <div class="card-content">
                    @if(hasReturnsUnderEnquiry) {
                        <p class="govuk-body govuk-!-margin-bottom-4">
                        @messages(s"homepage.returns.underEnquiry$maybeAgentKey.message")
                        </p>
                    }
                    <ul class="govuk-list">
                        <li class="card-links">
                            <a href="@dueAndOverdueReturnsUrl" class="govuk-link">@messages("homepage.returns.dueOverdueReturns.linkText")</a>
                        </li>
                        <li class="card-links">
                            <a href="@submissionHistoryUrl" class="govuk-link">@messages("homepage.returns.submissionHistory.linkText")</a>
                        </li>
                    </ul>
                </div>
            </div>
        }
        case None => {
            @if(hasReturnsUnderEnquiry) {
                <div class="card-half-width">
                    <div class="govuk-summary-card__title-wrapper">
                        <h2 class="govuk-heading-m govuk-!-margin-0">@messages("homepage.returns.title")</h2>
                    </div>
                    <div class="card-content">
                        <p class="govuk-body govuk-!-margin-bottom-4">
                        @messages(s"homepage.returns.underEnquiry$maybeAgentKey.message")
                        </p>
                        <ul class="govuk-list">
                            <li class="card-links">
                                <a href="@dueAndOverdueReturnsUrl" class="govuk-link">@messages("homepage.returns.dueOverdueReturns.linkText")</a>
                            </li>
                            <li class="card-links">
                                <a href="@submissionHistoryUrl" class="govuk-link">@messages("homepage.returns.submissionHistory.linkText")</a>
                            </li>
                        </ul>
                    </div>
                </div>
            } else {
                @card(
                    title = messages("homepage.returns.title"),
                    links = Seq(
                        (messages("homepage.returns.dueOverdueReturns.linkText"), dueAndOverdueReturnsUrl, None),
                        (messages("homepage.returns.submissionHistory.linkText"), submissionHistoryUrl, None),
                    )
                )
            }
        }
    }

 @if(maybePaymentBannerScenario.isDefined) {
     <div class="card-half-width">
         <div class="govuk-summary-card__title-wrapper card-with-tag">
             <h2 class="govuk-heading-m govuk-!-margin-0">@messages("homepage.payments.title")</h2>
             @maybePaymentBannerScenario.map {
                 case Outstanding => {
                     <span
                        class="govuk-tag govuk-tag--red"
                        aria-label="Outstanding payments"
                        title="Outstanding payments">
                       @messages("homepage.payments.tags.outstanding")
                     </span>
                 }
                 case Paid => {
                     <span
                     class="govuk-tag govuk-tag--green"
                     aria-label="Paid payments"
                     title="Paid payments">
                     @messages("homepage.payments.tags.paid")
                     </span>
                 }
             }
         </div>
         <div class="card-content">
             <ul class="govuk-list">
                 <li class="card-links">
                     <a href="@controllers.routes.TransactionHistoryController.onPageLoadTransactionHistory(None).url" class="govuk-link">@messages("homepage.payments.transactionHistory.linkText")</a>
                 </li>
                 <li class="card-links">
                     <a href="@controllers.payments.routes.OutstandingPaymentsController.onPageLoad.url" class="govuk-link">@messages("homepage.payments.outstandingPayments.linkText")</a>
                 </li>
                 <li class="card-links">
                     <a href="@controllers.repayments.routes.RequestRepaymentBeforeStartController.onPageLoad.url" class="govuk-link">@messages("homepage.payments.repayments.linkText")</a>
                 </li>
             </ul>
         </div>
     </div>
 } else {
     @card(
         title = messages("homepage.payments.title"),
         links = Seq(
             (messages("homepage.payments.transactionHistory.linkText"), controllers.routes.TransactionHistoryController.onPageLoadTransactionHistory(None).url, None),
             (messages("homepage.payments.outstandingPayments.linkText"), controllers.payments.routes.OutstandingPaymentsController.onPageLoad.url, None),
             (messages("homepage.payments.repayments.linkText"), controllers.repayments.routes.RequestRepaymentBeforeStartController.onPageLoad.url, None),
         )
     )
 }


   @{
    val registrationContent = Html(
     s"""
       <p class="govuk-body">
           <strong>${messages("homepage.manageAccount.registrationDate")}:</strong> $registrationDate
       </p>
     """
    )

    card(
     title = messages("homepage.manageAccount.title"),
     links = manageAccountLinks(isAgent),
     extraContent = Some(registrationContent),
     cardClass = "card-full-width"
    )
   }

 </div>
}

@manageAccountLinks(isAgent: Boolean) = @{
 Seq(
  (
          messages("homepage.manageAccount.manageContactDetails.linkText"),
          controllers.subscription.manageAccount.routes.ManageContactCheckYourAnswersController.onPageLoad.url,
          Some(messages(s"homepage.manageAccount$maybeAgentKey.manageContactDetails.body"))
  ),
  (
          messages("homepage.manageAccount.manageGroupDetails.linkText"),
          controllers.subscription.manageAccount.routes.ManageGroupDetailsCheckYourAnswersController.onPageLoad.url,
          Some(messages(s"homepage.manageAccount$maybeAgentKey.manageGroupDetails.body"))
  ),
  (
          messages("homepage.manageAccount.btn.linkText"),
          btnUrl,
          Some(messages(s"homepage.manageAccount$maybeAgentKey.btn.body"))
  )
 )
}